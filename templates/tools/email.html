{% extends "base.html" %}

{% block title %}Email Drafter & Sender - AI Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-envelope text-info me-2"></i>Email Drafter & Sender</h2>
                <p class="text-muted">Create professional emails and send them to customers</p>
            </div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Email Configuration</h5>
            </div>
            <div class="card-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="emailType" class="form-label">Email Type</label>
                        <select class="form-select" id="emailType" required>
                            <option value="">Select type</option>
                            <option value="marketing">Marketing</option>
                            <option value="customer_service">Customer Service</option>
                            <option value="follow_up">Follow Up</option>
                            <option value="thank_you">Thank You</option>
                            <option value="announcement">Announcement</option>
                            <option value="invitation">Invitation</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recipientType" class="form-label">Recipient Type</label>
                        <select class="form-select" id="recipientType">
                            <option value="customer">Existing Customer</option>
                            <option value="prospect">Potential Customer</option>
                            <option value="partner">Business Partner</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailTone" class="form-label">Tone</label>
                        <select class="form-select" id="emailTone">
                            <option value="professional">Professional</option>
                            <option value="friendly">Friendly</option>
                            <option value="casual">Casual</option>
                            <option value="formal">Formal</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailPurpose" class="form-label">Purpose/Subject</label>
                        <input type="text" class="form-control" id="emailPurpose" 
                               placeholder="e.g., Product launch announcement">
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailContext" class="form-label">Additional Context</label>
                        <textarea class="form-control" id="emailContext" rows="3" 
                                  placeholder="Any additional details or context..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="senderName" class="form-label">Sender Name</label>
                        <input type="text" class="form-control" id="senderName" 
                               value="Your Name" placeholder="Your name or team name">
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-info" id="generateBtn">
                            <i class="fas fa-magic me-1"></i>Generate Email
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Email Sending Section -->
        <div class="card mt-3" id="emailSendingCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">Send Email</h6>
            </div>
            <div class="card-body">
                <!-- Single Email -->
                <div class="mb-3">
                    <h6 class="text-primary">Send Single Email</h6>
                    <form id="singleEmailForm">
                        <div class="mb-2">
                            <input type="email" class="form-control form-control-sm" id="recipientEmail" 
                                   placeholder="Recipient email" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" id="recipientName" 
                                   placeholder="Recipient name (optional)">
                        </div>
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <i class="fas fa-paper-plane me-1"></i>Send Email
                        </button>
                    </form>
                </div>
                
                <hr>
                
                <!-- Bulk Email -->
                <div class="mb-3">
                    <h6 class="text-primary">Send Bulk Emails</h6>
                    <form id="bulkEmailForm">
                        <div class="mb-2">
                            <input type="file" class="form-control form-control-sm" id="csvFile" 
                                   accept=".csv" required>
                            <small class="text-muted">CSV format: name,email</small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-users me-1"></i>Send to All
                        </button>
                    </form>
                </div>
                
                <!-- CSV Example -->
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>CSV Example:</strong><br>
                        name,email<br>
                        John Smith,john@example.com<br>
                        Jane Doe,jane@example.com
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Generated Email</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="copyEmailBtn" style="display: none;">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                    <button class="btn btn-sm btn-primary" id="downloadBtn" style="display: none;">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="emailPreview" class="border rounded p-3" style="min-height: 400px; background: #f8f9fa;">
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-envelope fa-3x mb-3"></i>
                            <h5>Email Preview</h5>
                            <p>Configure your email settings and click "Generate Email" to create your professional email.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Results -->
        <div class="card mt-3" id="emailResults" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">Email Results</h6>
            </div>
            <div class="card-body">
                <div id="emailResultsContent"></div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Email Tips & Best Practices</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Subject Line Tips</h6>
                        <ul class="small">
                            <li>Keep it under 50 characters</li>
                            <li>Make it specific and actionable</li>
                            <li>Avoid spam trigger words</li>
                            <li>Personalize when possible</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">Content Tips</h6>
                        <ul class="small">
                            <li>Start with a clear greeting</li>
                            <li>Get to the point quickly</li>
                            <li>Include a clear call-to-action</li>
                            <li>End with professional closing</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const emailForm = document.getElementById('emailForm');
    const generateBtn = document.getElementById('generateBtn');
    const copyEmailBtn = document.getElementById('copyEmailBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const emailPreview = document.getElementById('emailPreview');
    const singleEmailForm = document.getElementById('singleEmailForm');
    const bulkEmailForm = document.getElementById('bulkEmailForm');
    const emailSendingCard = document.getElementById('emailSendingCard');
    const emailResults = document.getElementById('emailResults');
    
    let generatedEmail = '';
    let generatedSubject = '';
    let generatedBody = '';
    
    // Generate email
    emailForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            emailType: document.getElementById('emailType').value,
            recipientType: document.getElementById('recipientType').value,
            tone: document.getElementById('emailTone').value,
            purpose: document.getElementById('emailPurpose').value,
            context: document.getElementById('emailContext').value,
            senderName: document.getElementById('senderName').value
        };
        
        if (!formData.emailType) {
            alert('Please select an email type');
            return;
        }
        
        // Show loading state
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
        generateBtn.disabled = true;
        
        try {
            const response = await fetch('/api/draft-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                const email = result.email;
                generatedSubject = email.subject;
                generatedBody = email.body + '\n\n' + email.signature;
                generatedEmail = `Subject: ${generatedSubject}\n\n${generatedBody}`;
                
                displayEmail(generatedEmail);
                
                // Show action buttons
                copyEmailBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'inline-block';
                emailSendingCard.style.display = 'block';
                
            } else {
                alert('Failed to generate email: ' + result.message);
            }
        } catch (error) {
            console.error('Error generating email:', error);
            alert('Failed to generate email');
        } finally {
            generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Generate Email';
            generateBtn.disabled = false;
        }
    });
    
    // Send single email
    singleEmailForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!generatedSubject || !generatedBody) {
            alert('Please generate an email first');
            return;
        }
        
        const email = document.getElementById('recipientEmail').value;
        const name = document.getElementById('recipientName').value;
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    name: name,
                    subject: generatedSubject,
                    body: generatedBody
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showResults('success', result.message);
                singleEmailForm.reset();
            } else {
                showResults('error', result.message);
            }
            
        } catch (error) {
            showResults('error', 'Error sending email: ' + error.message);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // Send bulk emails
    bulkEmailForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!generatedSubject || !generatedBody) {
            alert('Please generate an email first');
            return;
        }
        
        const csvFile = document.getElementById('csvFile').files[0];
        if (!csvFile) {
            alert('Please select a CSV file');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        submitBtn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('csv_file', csvFile);
            formData.append('subject', generatedSubject);
            formData.append('body', generatedBody);
            
            const response = await fetch('/api/send-bulk-emails', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                let message = result.message;
                if (result.errors && result.errors.length > 0) {
                    message += '\n\nErrors:\n' + result.errors.join('\n');
                }
                showResults('success', message);
                bulkEmailForm.reset();
            } else {
                showResults('error', result.message);
            }
            
        } catch (error) {
            showResults('error', 'Error sending bulk emails: ' + error.message);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // Copy email functionality
    copyEmailBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(generatedEmail).then(() => {
            this.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-copy me-1"></i>Copy';
            }, 2000);
        });
    });
    
    // Download email functionality
    downloadBtn.addEventListener('click', function() {
        const blob = new Blob([generatedEmail], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'email.txt';
        a.click();
        URL.revokeObjectURL(url);
    });
    
    // Helper functions
    function displayEmail(email) {
        const lines = email.split('\n');
        const subject = lines[0];
        const body = lines.slice(1).join('\n');
        
        emailPreview.innerHTML = `
            <div class="email-display">
                <div class="email-header mb-3 p-3 bg-white border rounded">
                    <div class="mb-2"><strong>${subject}</strong></div>
                    <div class="text-muted small">
                        <div>From: ${document.getElementById('senderName').value} &lt;your@email.com&gt;</div>
                        <div>To: [Recipient Email]</div>
                        <div>Date: ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
                <div class="email-body bg-white p-3 border rounded">
                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${body}</pre>
                </div>
            </div>
        `;
    }
    
    function showResults(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        
        document.getElementById('emailResultsContent').innerHTML = `
            <div class="alert ${alertClass}">
                <i class="fas ${icon} me-2"></i>
                <pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">${message}</pre>
            </div>
        `;
        
        emailResults.style.display = 'block';
        
        // Auto-hide after 10 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                emailResults.style.display = 'none';
            }, 10000);
        }
    }
});
</script>
<script src="{{ url_for('static', filename='js/speech_integration.js') }}"></script>
<script src="{{ url_for('static', filename='js/enhanced_form_integration.js') }}"></script>
{% endblock %}