{% extends "base.html" %}

{% block title %}Feedback Analyzer - AI Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-comments text-success me-2"></i>Feedback Analyzer</h2>
                <p class="text-muted">Analyze customer feedback and reviews to gain valuable insights</p>
            </div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Feedback Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="totalFeedback">{{ feedback_list|length }}</h4>
                <p class="mb-0">Total Feedback</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="avgRating">
                    {% if feedback_list %}
                        {{ "%.1f"|format((feedback_list|sum(attribute='rating'))/feedback_list|length) }}
                    {% else %}
                        0.0
                    {% endif %}
                </h4>
                <p class="mb-0">Average Rating</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="positiveFeedback">
                    {{ feedback_list|selectattr('rating', 'ge', 4)|list|length }}
                </h4>
                <p class="mb-0">Positive (4-5★)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="negativeFeedback">
                    {{ feedback_list|selectattr('rating', 'le', 2)|list|length }}
                </h4>
                <p class="mb-0">Negative (1-2★)</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Feedback Input</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="analysisMode" id="manualMode" checked>
                        <label class="btn btn-outline-primary btn-sm" for="manualMode">Manual Text</label>
                        
                        <input type="radio" class="btn-check" name="analysisMode" id="storedMode">
                        <label class="btn btn-outline-primary btn-sm" for="storedMode">Stored Feedback</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Manual Text Analysis -->
                <div id="manualAnalysis">
                    <form id="feedbackForm">
                        <div class="mb-3">
                            <label for="feedbackTitle" class="form-label">Analysis Title (Optional)</label>
                            <input type="text" class="form-control" id="feedbackTitle" placeholder="e.g., Customer Service Review">
                        </div>
                        
                        <div class="mb-3">
                            <label for="feedbackText" class="form-label">Feedback Text</label>
                            <textarea class="form-control" id="feedbackText" rows="8" 
                                      placeholder="Paste customer feedback, reviews, or comments here..." required></textarea>
                            <div class="form-text">
                                <span id="wordCount">0</span> words
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="analyzeBtn">
                                <i class="fas fa-search me-1"></i>Analyze Feedback
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Stored Feedback Selection -->
                <div id="storedAnalysis" style="display: none;">
                    <div class="mb-3">
                        <label for="feedbackSelect" class="form-label">Select Feedback to Analyze</label>
                        <select class="form-select" id="feedbackSelect">
                            <option value="">Choose stored feedback...</option>
                            {% for feedback in feedback_list %}
                            <option value="{{ feedback.id }}" 
                                    data-rating="{{ feedback.rating }}" 
                                    data-website="{{ feedback.website_title or 'Website #' + feedback.website_id|string }}"
                                    data-date="{{ feedback.created_at }}">
                                {{ feedback.customer_name }} - {{ feedback.rating }}★ - {{ feedback.website_title or 'Website #' + feedback.website_id|string }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="selectedFeedbackPreview" class="mb-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Selected Feedback Preview</h6>
                                <p id="previewText" class="card-text text-muted"></p>
                                <small class="text-muted">
                                    <span id="previewCustomer"></span> • 
                                    <span id="previewRating"></span> • 
                                    <span id="previewDate"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="button" class="btn btn-success" id="analyzeStoredBtn" disabled>
                            <i class="fas fa-search me-1"></i>Analyze Selected Feedback
                        </button>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Sample Feedback</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Positive Example:</strong></p>
                        <p class="text-muted small mb-3">"The service was excellent and the staff was very helpful. I would definitely recommend this company to others!"</p>
                        
                        <p class="mb-2"><strong>Negative Example:</strong></p>
                        <p class="text-muted small mb-0">"The product arrived late and was damaged. Customer service was unhelpful and rude."</p>
                        
                        <button class="btn btn-outline-primary btn-sm mt-2" id="loadSample">
                            Load Sample Text
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Analysis Results</h5>
            </div>
            <div class="card-body" id="resultsContainer">
                <div class="text-center text-muted" id="noResults">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <h5>Analysis Results</h5>
                    <p>Enter feedback text or select stored feedback and click "Analyze" to see detailed insights.</p>
                </div>
                
                <div id="analysisResults" style="display: none;">
                    <!-- Sentiment Overview -->
                    <div class="mb-4">
                        <h6>Sentiment Analysis</h6>
                        <div class="d-flex align-items-center mb-2">
                            <span class="me-2">Overall Sentiment:</span>
                            <span class="badge" id="sentimentBadge">Neutral</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar" id="sentimentBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Confidence: <span id="confidenceScore">0%</span></small>
                    </div>
                    
                    <!-- Key Insights -->
                    <div class="mb-4">
                        <h6>Key Insights</h6>
                        <div id="insightsList"></div>
                    </div>
                    
                    <!-- Top Keywords -->
                    <div class="mb-4">
                        <h6>Top Keywords</h6>
                        <div id="keywordsList"></div>
                    </div>
                    
                    <!-- Themes -->
                    <div class="mb-4">
                        <h6>Main Themes</h6>
                        <div id="themesList"></div>
                    </div>
                    
                    <!-- Emotions -->
                    <div class="mb-4">
                        <h6>Emotional Analysis</h6>
                        <div id="emotionsList"></div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="mb-3">
                        <h6>Summary</h6>
                        <p id="summaryText" class="text-muted"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Feedback Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Customer Feedback</h5>
                    <button class="btn btn-primary btn-sm" id="refreshFeedback">
                        <i class="fas fa-refresh me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Website</th>
                                <th>Rating</th>
                                <th>Feedback</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="feedbackTable">
                            {% if feedback_list %}
                                {% for feedback in feedback_list %}
                                <tr data-feedback-id="{{ feedback.id }}">
                                    <td>
                                        <strong>{{ feedback.customer_name }}</strong><br>
                                        <small class="text-muted">{{ feedback.customer_email }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ feedback.website_title or 'Website #' + feedback.website_id|string }}</span>
                                        {% if feedback.website_keyword %}
                                        <br><small class="text-muted">{{ feedback.website_keyword }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-{{ 'success' if feedback.rating >= 4 else 'warning' if feedback.rating == 3 else 'danger' }}">
                                                {{ feedback.rating }}★
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" title="{{ feedback.feedback_text }}">
                                            {{ feedback.feedback_text }}
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ feedback.created_at[:10] if feedback.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        {% if feedback.is_analyzed %}
                                        <span class="badge bg-success">Analyzed</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary analyze-feedback-btn" 
                                                    data-feedback-id="{{ feedback.id }}"
                                                    title="Analyze this feedback">
                                                <i class="fas fa-search"></i>
                                            </button>
                                            <button class="btn btn-outline-info view-feedback-btn" 
                                                    data-feedback-id="{{ feedback.id }}"
                                                    title="View full feedback">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-comment-slash fa-2x mb-2"></i><br>
                                        No feedback received yet. Generate websites with feedback forms to start collecting customer insights.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Details Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Feedback Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const feedbackText = document.getElementById('feedbackText');
    const wordCount = document.getElementById('wordCount');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeStoredBtn = document.getElementById('analyzeStoredBtn');
    const loadSampleBtn = document.getElementById('loadSample');
    const feedbackSelect = document.getElementById('feedbackSelect');
    const manualMode = document.getElementById('manualMode');
    const storedMode = document.getElementById('storedMode');
    const manualAnalysis = document.getElementById('manualAnalysis');
    const storedAnalysis = document.getElementById('storedAnalysis');
    
    // Mode switching
    manualMode.addEventListener('change', function() {
        if (this.checked) {
            manualAnalysis.style.display = 'block';
            storedAnalysis.style.display = 'none';
        }
    });
    
    storedMode.addEventListener('change', function() {
        if (this.checked) {
            manualAnalysis.style.display = 'none';
            storedAnalysis.style.display = 'block';
        }
    });
    
    // Word count
    feedbackText.addEventListener('input', function() {
        const words = this.value.trim().split(/\s+/).filter(word => word.length > 0);
        wordCount.textContent = words.length;
    });
    
    // Feedback selection preview
    feedbackSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const preview = document.getElementById('selectedFeedbackPreview');
        const analyzeBtn = document.getElementById('analyzeStoredBtn');
        
        if (this.value) {
            // Find feedback data
            const feedbackId = this.value;
            // You would typically fetch this from the server or have it embedded
            preview.style.display = 'block';
            analyzeBtn.disabled = false;
            
            // Update preview (simplified - in real app you'd fetch full data)
            document.getElementById('previewCustomer').textContent = selectedOption.text.split(' - ')[0];
            document.getElementById('previewRating').textContent = selectedOption.getAttribute('data-rating') + '★';
            document.getElementById('previewDate').textContent = selectedOption.getAttribute('data-date').substr(0, 10);
        } else {
            preview.style.display = 'none';
            analyzeBtn.disabled = true;
        }
    });
    
    // Load sample text
    loadSampleBtn.addEventListener('click', function() {
        feedbackText.value = "The service was excellent and the staff was very helpful. However, the wait time was a bit long and the prices seem high for what you get. Overall, I would recommend this place to others, but they could improve on efficiency and value for money.";
        feedbackText.dispatchEvent(new Event('input'));
        manualMode.checked = true;
        manualMode.dispatchEvent(new Event('change'));
    });
    
    // Analyze manual feedback
    document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const text = feedbackText.value.trim();
        if (!text) {
            alert('Please enter some feedback text to analyze.');
            return;
        }
        
        await analyzeText(text);
    });
    
    // Analyze stored feedback
    analyzeStoredBtn.addEventListener('click', async function() {
        const feedbackId = feedbackSelect.value;
        if (!feedbackId) {
            alert('Please select a feedback to analyze.');
            return;
        }
        
        await analyzeStoredFeedback(feedbackId);
    });
    
    // Individual feedback analysis buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.analyze-feedback-btn')) {
            const feedbackId = e.target.closest('.analyze-feedback-btn').getAttribute('data-feedback-id');
            analyzeStoredFeedback(feedbackId);
        }
        
        if (e.target.closest('.view-feedback-btn')) {
            const feedbackId = e.target.closest('.view-feedback-btn').getAttribute('data-feedback-id');
            viewFeedbackDetails(feedbackId);
        }
    });
    
    // Refresh feedback
    document.getElementById('refreshFeedback').addEventListener('click', function() {
        location.reload();
    });
});

async function analyzeText(text) {
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    // Show loading state
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
    analyzeBtn.disabled = true;
    
    try {
        const response = await fetch('/api/analyze-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedback: text })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            displayResults(result.analysis);
        } else {
            alert('Analysis failed: ' + (result.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Analysis failed:', error);
        alert('Analysis failed. Please try again.');
    } finally {
        analyzeBtn.innerHTML = '<i class="fas fa-search me-1"></i>Analyze Feedback';
        analyzeBtn.disabled = false;
    }
}

async function analyzeStoredFeedback(feedbackId) {
    const analyzeBtn = document.getElementById('analyzeStoredBtn');
    
    // Show loading state
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
    analyzeBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/analyze-stored-feedback/${feedbackId}`);
        const result = await response.json();
        
        if (result.status === 'success') {
            displayResults(result.analysis);
            
            // Update the table row to show analyzed status
            const row = document.querySelector(`tr[data-feedback-id="${feedbackId}"]`);
            if (row) {
                const statusCell = row.querySelector('td:nth-child(6) .badge');
                if (statusCell) {
                    statusCell.className = 'badge bg-success';
                    statusCell.textContent = 'Analyzed';
                }
            }
        } else {
            alert('Analysis failed: ' + (result.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Analysis failed:', error);
        alert('Analysis failed. Please try again.');
    } finally {
        analyzeBtn.innerHTML = '<i class="fas fa-search me-1"></i>Analyze Selected Feedback';
        analyzeBtn.disabled = false;
    }
}

function viewFeedbackDetails(feedbackId) {
    // This would fetch and display full feedback details
    // For now, show a placeholder
    const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    document.getElementById('modalContent').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Loading feedback details...</p>
        </div>
    `;
    modal.show();
    
    // Simulate loading
    setTimeout(() => {
        document.getElementById('modalContent').innerHTML = `
            <div class="alert alert-info">
                <h6>Feedback ID: ${feedbackId}</h6>
                <p>Full feedback details would be displayed here, including:</p>
                <ul>
                    <li>Complete feedback text</li>
                    <li>Customer information</li>
                    <li>Analysis results (if available)</li>
                    <li>Response tracking</li>
                </ul>
            </div>
        `;
    }, 1000);
}

function displayResults(analysis) {
    document.getElementById('noResults').style.display = 'none';
    document.getElementById('analysisResults').style.display = 'block';
    
    // Sentiment
    const sentimentBadge = document.getElementById('sentimentBadge');
    const sentimentBar = document.getElementById('sentimentBar');
    const confidenceScore = document.getElementById('confidenceScore');
    
    sentimentBadge.textContent = analysis.sentiment.label.charAt(0).toUpperCase() + analysis.sentiment.label.slice(1);
    sentimentBadge.className = `badge bg-${getSentimentColor(analysis.sentiment.label)}`;
    
    const percentage = Math.abs(analysis.sentiment.score * 100);
    sentimentBar.style.width = `${percentage}%`;
    sentimentBar.className = `progress-bar bg-${getSentimentColor(analysis.sentiment.label)}`;
    
    confidenceScore.textContent = `${Math.round(analysis.sentiment.confidence * 100)}%`;
    
    // Keywords
    const keywordsList = document.getElementById('keywordsList');
    keywordsList.innerHTML = analysis.keywords.top_keywords.map(kw => 
        `<span class="badge bg-secondary me-2 mb-1">${kw.word} (${kw.count})</span>`
    ).join('');
    
    // Themes
    const themesList = document.getElementById('themesList');
    themesList.innerHTML = Object.entries(analysis.themes).map(([theme, data]) => `
        <div class="mb-2">
            <div class="d-flex justify-content-between">
                <span>${theme.replace('_', ' ').toUpperCase()}</span>
                <span>${data.percentage}%</span>
            </div>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-info" style="width: ${data.percentage}%"></div>
            </div>
        </div>
    `).join('');
    
    // Emotions
    const emotionsList = document.getElementById('emotionsList');
    if (analysis.emotions && analysis.emotions.all_emotions) {
        emotionsList.innerHTML = Object.entries(analysis.emotions.all_emotions).map(([emotion, data]) => `
            <span class="badge bg-${getEmotionColor(emotion)} me-2 mb-1">${emotion} (${data.intensity})</span>
        `).join('');
    } else {
        emotionsList.innerHTML = `<span class="badge bg-secondary">No strong emotions detected</span>`;
    }
    
    // Insights
    const insightsList = document.getElementById('insightsList');
    insightsList.innerHTML = analysis.insights.map(insight => `
        <div class="alert alert-${getInsightColor(insight.type)} py-2">
            <small><strong>${insight.category}:</strong> ${insight.message}</small>
        </div>
    `).join('');
    
    // Summary
    document.getElementById('summaryText').textContent = analysis.summary;
}

function getSentimentColor(sentiment) {
    switch(sentiment) {
        case 'positive': return 'success';
        case 'negative': return 'danger';
        default: return 'secondary';
    }
}

function getInsightColor(type) {
    switch(type) {
        case 'positive': return 'success';
        case 'improvement': return 'warning';
        case 'negative': return 'danger';
        default: return 'info';
    }
}

function getEmotionColor(emotion) {
    const colors = {
        'joy': 'success',
        'anger': 'danger',
        'sadness': 'primary',
        'fear': 'warning',
        'surprise': 'info',
        'disgust': 'dark'
    };
    return colors[emotion] || 'secondary';
}
</script>
<script src="{{ url_for('static', filename='js/speech_integration.js') }}"></script>
<script src="{{ url_for('static', filename='js/enhanced_form_integration.js') }}"></script>
{% endblock %}